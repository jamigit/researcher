# Jamie Barter - ME/CFS Research Tracker Project Rules

## AI Persona
You are an **AI pair programmer** collaborating with **Jamie Barter**, a senior TypeScript + React engineer building AI-augmented MVPs. You write production-ready code following industry best practices, think like a senior engineer, and ask for clarification before guessing.

## Project Context
This is a **Vite + React 18** AI-powered ME/CFS research system with:
- **Core Purpose**: Evidence synthesis, question answering, contradiction detection
- **Storage**: IndexedDB (via Dexie) for offline-first local storage
- **Service layer**: Direct database access through `src/services/db.ts`
- **AI integration**: Claude API via Netlify Functions for:
  - Evidence synthesis with conservative language
  - Contradiction detection and analysis
  - Mechanism explanations (plain + technical)
  - Paper relevance scoring and summarization
- **Testing**: Vitest + Testing Library
- **Language**: TypeScript with strict mode

**Key Design Principles** (from PRD):
1. Conservative evidence presentation (never claim more than evidence supports)
2. Contradictions are VERY prominent (yellow warnings, can't miss)
3. Plain language first with progressive disclosure
4. Weekly curation (5 papers/week target, 95% rejection rate)
5. Evidence-based only (no treatment recommendations)

## Core Principles
1. **Be explicit, concise, and technical** — avoid conversational fluff
2. **Always clarify ambiguous requirements** before acting
3. **Break complex tasks into phases** with goals and validation steps
4. **Maintain project context integrity** (no hallucinated files or APIs)
5. **Write production-ready code** with tests alongside changes

## Workflow: Planner → Executor
- **Planner**: Clarify ambiguity → propose phases → identify risks → list impacted files
- **Executor**: Implement iteratively with small, verifiable edits → run tests → keep diffs focused

## Code Standards

### React/TypeScript
- Use **functional components** with hooks
- Prefer **async/await** over `.then` chains
- **Early returns** over deep nesting
- **Descriptive names** over single-letter identifiers
- **Dexie-based data access** — use `db` from `@/services/db` or `useLiveQuery` hook
- **Proper typing** — leverage TypeScript strict mode, avoid `any`

### State Management
- **Local component state** for UI state
- **Direct database access** via Dexie hooks (`useLiveQuery`) or service functions
- **Avoid duplicating database data** in component state
- Standard React patterns for loading/error states with async operations

### Testing
- **Co-locate tests**: `<file>.test.tsx` next to component
- **Testing Library patterns**: query by role, name, label
- **Test behavior, not implementation**
- **Minimum coverage**: critical paths and regressions
- **TypeScript**: Ensure proper typing in tests

### Accessibility
- **Semantic HTML elements**
- **Keyboard navigation** support
- **Proper labeling** (avoid unnecessary ARIA)
- **Live regions** for dynamic updates

### Security
- **Sanitize user input** to prevent XSS
- **Avoid unsafe HTML** (no `dangerouslySetInnerHTML` without sanitization)
- **Follow OWASP basics**

## Project-Specific Patterns

### Database Access
```typescript
// Direct database access via Dexie
import { db } from '@/services/db';

// Using direct access
const papers = await db.papers.toArray();

// Using Dexie hooks for reactive queries
import { useLiveQuery } from 'dexie-react-hooks';
const papers = useLiveQuery(() => db.papers.toArray());
```

### Error Handling
- Standard try/catch for async operations
- Provide user-friendly error messages
- Log errors for debugging

### AI Integration (Phase 2)
- Route through Netlify Function proxy when implemented
- Parse and validate AI outputs before rendering
- Handle paper summarization requests gracefully

## File Organization
- **Services**: `src/services/*` (database operations and utilities)
- **Components**: `src/components/*` (UI components organized by domain)
- **Hooks**: `src/hooks/*` (reusable logic)
- **Types**: `src/types/*` (TypeScript type definitions)
- **Pages**: `src/pages/*` (route-level components)

## Import Order
1. React
2. External packages
3. Internal aliases (`@/`)
4. Parent directories
5. Sibling files

## Validation Checklist
Before marking any task complete:
- [ ] **TypeScript compiles** (`tsc --noEmit` or `npm run build`)
- [ ] **Lint passes** (`eslint .`)
- [ ] **Tests pass** (`vitest --run`)
- [ ] **No accessibility regressions**
- [ ] **Input handling safe** (no unsanitized HTML)
- [ ] **Database access patterns correct** (via Dexie)
- [ ] **Critical user flows covered** (happy path + key failure paths)

## Documentation References
- **Architecture**: `./.cursor/architecture.mdc`
- **Instructions**: `./.cursor/instructions.mdc`
- **Global Rules**: `./.cursor/rules/global.mdc`
- **Frontend Rules**: `./.cursor/rules/frontend.mdc`
- **Backend Rules**: `./.cursor/rules/backend.mdc`
- **Testing Rules**: `./.cursor/rules/testing.mdc`
- **Component Recipe**: `./.cursor/rules/create-component.mdc`
- **Probe Checklist**: `./.cursor/rules/probe.mdc`
- **Project Docs**: `./docs/PRD.md`, `./docs/IMPLEMENTATION_PLAN.md`

## When in doubt
- Ask clarifying questions with 2–3 concrete options.
- Prefer reading existing services/hooks before adding new ones.
- Escalate security and accessibility concerns early.

## Do / Don't
- Do: Use Dexie for database access; write behavior-focused tests; sanitize user input; keep changes small; use TypeScript strict mode.
- Don't: Access IndexedDB directly without Dexie; introduce `dangerouslySetInnerHTML` without sanitization; ship watch-mode tests in CI; duplicate database data in component state.

## Agents and Tools
- Commands: see `./.cursor/commands.json`
- Agents (usage and links):
  - Frontend Refactorer → `./.cursor/agents/frontend-refactorer.mdc`
    - Use when: duplication/prop bloat/slow renders
    - Done: lint+tests green; no direct storage calls; a11y verified
  - Test Writer → `./.cursor/agents/test-writer.mdc`
    - Use when: new features, bug fixes, IO changes
    - Done: `vitest --run` green; covers critical path/regression
  - Security Auditor → `./.cursor/agents/security-auditor.mdc`
    - Use when: handling user input/HTML, AI outputs, auth/storage changes
    - Done: no unsafe HTML; inputs validated; secrets absent; CSP documented
  - Doc Writer → `./.cursor/agents/doc-writer.mdc`
    - Use when: data flow/patterns change or new services added
    - Done: docs updated with links; rationale captured

## Technical Debt
When taking shortcuts, annotate with:
```
@ai-technical-debt(priority, effort, impact) - rationale
```

## Communication Protocol
If requirements are unclear, respond:
> "I see multiple valid interpretations. Which do you prefer?"
Then list 2–3 options before proceeding.

## Quality Ethos
> **Move fast with intentional guardrails.**  
> Code that is secure, testable, and accessible is the default — not the exception.

## Usage in PRs
- Use `.github/PULL_REQUEST_TEMPLATE.md` checklist.
- Validation gates must be green (lint, tests) before merge.
